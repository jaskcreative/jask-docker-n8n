# Container Name: N8N
# File Name: docker-compose.yml
# Description: Docker Compose configuration for the N8N workflow automation platform, including PostgreSQL and Qdrant.
# Docker Internal Network: jask-internal-net

networks:
  jask-internal-net:
    name: jask-internal-net
    external: false

services:
  # Redis service for N8N (PROTEGIDO CON CONTRASEÃ‘A)
  redis:
    image: redis:7-alpine
    container_name: n8n-redis
    restart: unless-stopped
    command: redis-server --save 60 1 --loglevel warning --requirepass ${REDIS_PASSWORD}
    env_file:
      - .env
    volumes:
      - ./service-data/redis-data:/data
    networks:
      - jask-internal-net
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # PostgreSQL database service for N8N
  postgres:
    image: postgres:16-alpine
    container_name: n8n-postgres
    restart: unless-stopped
    user: "${UID}:${GID}"
    env_file:
      - .env
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    volumes:
      - ./service-data/postgres-data:/var/lib/postgresql/data
    ports:
      - "${DB_EXTERNAL_PORT}:5432"
    networks:
      - jask-internal-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME}"]
      interval: 5s
      timeout: 5s
      retries: 10

  # Qdrant vector store service
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - TZ=${TZ}
    ports:
      - "6333:6333"
    volumes:
      - ./service-data/qdrant-storage:/qdrant/storage
      - ./service-data/qdrant-snapshots:/qdrant/snapshots
    networks:
      - jask-internal-net

  # N8N core service
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    ports:
      - "5678:5678"
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - TZ=${TZ}
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE}

      - N8N_HOST=${N8N_HOST}
      - N8N_PORT=${N8N_PORT}
      - N8N_PROTOCOL=${N8N_PROTOCOL}
      - N8N_EDITOR_BASE_URL=${N8N_EDITOR_BASE_URL}
      - N8N_API_BASE_URL=${N8N_API_BASE_URL}
      - WEBHOOK_URL=${WEBHOOK_URL}
      - N8N_PROXY_HOPS=${N8N_PROXY_HOPS}
      - N8N_TRUSTED_PROXIES=${N8N_TRUSTED_PROXIES}
      - N8N_SECURE_COOKIE=${N8N_SECURE_COOKIE}

      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=${N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS}
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=${N8N_BLOCK_ENV_ACCESS_IN_NODE}
      - N8N_GIT_NODE_DISABLE_BARE_REPOS=${N8N_GIT_NODE_DISABLE_BARE_REPOS}
      - N8N_RUNNERS_ENABLED=${N8N_RUNNERS_ENABLED}

      # Database config
      - DB_TYPE=${DB_TYPE}
      - DB_POSTGRESDB_HOST=${DB_HOST}
      - DB_POSTGRESDB_PORT=${DB_PORT}
      - DB_POSTGRESDB_DATABASE=${DB_NAME}
      - DB_POSTGRESDB_USER=${DB_USER}
      - DB_POSTGRESDB_PASSWORD=${DB_PASSWORD}

      # Qdrant
      - QDRANT_BASE_URL=${QDRANT_BASE_URL}

      # Redis (AHORA CON PASSWORD)
      - QUEUE_BULL_REDIS_HOST=redis
      - QUEUE_BULL_REDIS_PORT=6379
      - QUEUE_BULL_REDIS_PASSWORD=${REDIS_PASSWORD}

      # compatibilidad legacy
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}

    depends_on:
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_started
      redis:
        condition: service_healthy

    volumes:
      - ./service-data/n8n-data:/home/node/.n8n
      - ./service-data/n8n-shared:/files
      - ./service-data/backups:/home/node/backups

    networks:
      - jask-internal-net

  # MCP service for N8N
  n8n-mcp:
    image: ghcr.io/czlonkowski/n8n-mcp:latest
    container_name: n8n-mcp
    restart: unless-stopped
    environment:
      - N8N_API_URL=http://n8n:5678/api/v1
      - N8N_API_KEY=${MCP_N8N_API_KEY}
      - MCP_MODE=http
      - AUTH_TOKEN=${MCP_AUTH_TOKEN}
    ports:
      - "${MCP_PORT:-3000}:3000"
    networks:
      - jask-internal-net
    depends_on:
      n8n:
        condition: service_started